<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vehicle Inventory Intelligence</title>
<style>
:root{--p:#1a1a2e;--s:#16213e;--a:#0f3460;--h:#e94560;--ok:#00b894;--warn:#fdcb6e;--bad:#e17055;--t:#dfe6e9;--tm:#b2bec3;--cb:#1e2a3a;--ib:#0d1b2a;--bd:#2d3e50}
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--p);color:var(--t);min-height:100vh;line-height:1.6}
::-webkit-scrollbar{width:8px}::-webkit-scrollbar-thumb{background:var(--a);border-radius:4px}
.hd{background:var(--s);border-bottom:2px solid var(--h);padding:16px 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.logo{display:flex;align-items:center;gap:12px}.logo-i{width:44px;height:44px;background:linear-gradient(135deg,#e94560,#0f3460);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:bold;color:#fff}
.logo h1{font-size:18px}.logo span{font-size:11px;color:var(--tm);text-transform:uppercase;letter-spacing:2px}
.hd-btns{display:flex;gap:8px}.hd-btn{padding:7px 16px;border:1px solid var(--bd);background:0;color:var(--t);border-radius:7px;cursor:pointer;font-size:13px;transition:.3s}.hd-btn:hover{border-color:var(--h);color:var(--h)}
.mx{max-width:1400px;margin:0 auto;padding:24px 32px}
.tabs{display:flex;gap:6px;margin-bottom:20px;flex-wrap:wrap}
.tab{padding:9px 20px;border:1px solid var(--bd);background:var(--cb);color:var(--tm);border-radius:9px;cursor:pointer;font-size:13px;font-weight:600;transition:.3s}.tab:hover{border-color:var(--a)}.tab.on{background:var(--h);border-color:var(--h);color:#fff}
.pane{display:none}.pane.on{display:block}
.card{background:var(--cb);border:1px solid var(--bd);border-radius:14px;padding:24px;margin-bottom:20px}.card:hover{border-color:var(--a)}
.card-hd{display:flex;align-items:center;gap:10px;margin-bottom:20px;padding-bottom:14px;border-bottom:1px solid var(--bd)}
.card-ic{width:36px;height:36px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px}
.card-tt{font-size:15px;font-weight:600}.card-st{font-size:11px;color:var(--tm)}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.fg{display:flex;flex-direction:column;gap:5px}.fg.fw{grid-column:1/-1}
.fg label{font-size:11px;font-weight:600;color:var(--tm);text-transform:uppercase;letter-spacing:.5px}
.fg input,.fg select,.fg textarea{padding:10px 14px;background:var(--ib);border:1px solid var(--bd);border-radius:9px;color:var(--t);font-size:13px;font-family:inherit;outline:0;transition:.3s}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--h);box-shadow:0 0 0 3px rgba(233,69,96,.1)}
.fg input::placeholder{color:#4a5568}.fg textarea{resize:vertical;min-height:70px}.fg select{cursor:pointer}
.fg-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.bar{display:flex;gap:12px;justify-content:center;margin:24px 0;flex-wrap:wrap}
.btn{padding:14px 36px;border:0;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;transition:.3s;font-family:inherit}
.btn-p{background:linear-gradient(135deg,#e94560,#0f3460);color:#fff;box-shadow:0 4px 20px rgba(233,69,96,.3)}.btn-p:hover{transform:translateY(-2px)}
.btn-s{background:0;color:var(--t);border:2px solid var(--bd)}.btn-s:hover{border-color:var(--tm)}
.btn-g{background:rgba(0,184,148,.15);color:var(--ok);border:1px solid rgba(0,184,148,.3)}.btn-g:hover{background:rgba(0,184,148,.25)}
.btn-sm{padding:10px 20px;font-size:13px}
.ld{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(26,26,46,.95);z-index:1000;justify-content:center;align-items:center;flex-direction:column;gap:20px}.ld.on{display:flex}
.sp{width:50px;height:50px;border:4px solid var(--bd);border-top-color:var(--h);border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
.ld-t{font-size:16px;color:var(--tm)}
.rpt{display:none;margin-top:20px}.rpt.on{display:block}
.rpt-hd{background:var(--cb);border:1px solid var(--bd);border-radius:14px;padding:28px;margin-bottom:20px}
.rpt-hd h2{font-size:24px;font-weight:700;margin-bottom:8px}
.meta{display:flex;gap:20px;flex-wrap:wrap}.meta-i{display:flex;flex-direction:column}.meta-l{font-size:10px;text-transform:uppercase;color:var(--tm);letter-spacing:1px}.meta-v{font-size:15px;font-weight:600}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px}
.kpi{background:var(--cb);border:1px solid var(--bd);border-radius:11px;padding:20px;text-align:center}
.kpi-l{font-size:10px;text-transform:uppercase;color:var(--tm);letter-spacing:1px;margin-bottom:6px}.kpi-v{font-size:24px;font-weight:700}.kpi-d{font-size:11px;color:var(--tm);margin-top:3px}
.grn{color:var(--ok)}.ylw{color:var(--warn)}.red{color:var(--bad)}.blu{color:#74b9ff}
.rc{background:var(--cb);border:1px solid var(--bd);border-radius:14px;margin-bottom:20px;overflow:hidden}
.rc-h{padding:20px 24px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:14px}
.rc-n{width:32px;height:32px;background:linear-gradient(135deg,#e94560,#0f3460);border-radius:9px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;color:#fff;flex-shrink:0}
.rc-t{font-size:16px;font-weight:700}.rc-b{padding:24px}.rc-b p{font-size:13px;line-height:1.7;color:var(--tm);margin-bottom:10px}.rc-b strong{color:var(--t)}.rc-b h3{font-size:15px;margin:16px 0 8px}
.badge{display:inline-block;padding:3px 10px;border-radius:16px;font-size:11px;font-weight:600}
.b-grn{background:rgba(0,184,148,.15);color:var(--ok)}.b-ylw{background:rgba(253,203,110,.15);color:var(--warn)}.b-red{background:rgba(233,69,96,.15);color:var(--h)}
.tbl{width:100%;border-collapse:separate;border-spacing:0;margin:14px 0}
.tbl thead th{background:var(--ib);padding:10px 14px;text-align:left;font-size:11px;text-transform:uppercase;color:var(--tm);font-weight:600;border-bottom:2px solid var(--bd)}
.tbl tbody td{padding:10px 14px;border-bottom:1px solid var(--bd);font-size:13px}
.co{padding:16px 20px;border-radius:10px;margin:14px 0;border-left:4px solid}
.co-r{background:rgba(233,69,96,.08);border-color:var(--h)}.co-g{background:rgba(0,184,148,.08);border-color:var(--ok)}.co-b{background:rgba(116,185,255,.08);border-color:#74b9ff}.co-y{background:rgba(253,203,110,.08);border-color:var(--warn)}
.co h4{margin-bottom:6px;font-size:13px;text-transform:uppercase;letter-spacing:.5px}.co p,.co li{font-size:13px;line-height:1.7;color:var(--tm)}.co ul{margin:6px 0 0 18px}
.rb{background:var(--ib);border:2px solid var(--h);border-radius:10px;padding:20px;margin:16px 0;text-align:center}
.rb-a{font-size:22px;font-weight:700;color:var(--h)}.rb-d{font-size:15px;color:var(--t)}.rb-s{font-size:12px;color:var(--tm);margin-top:6px}
.ai{background:var(--ib);border:1px solid var(--bd);border-radius:10px;padding:16px 20px;margin:10px 0;display:flex;gap:14px;align-items:flex-start}
.ai-n{width:28px;height:28px;background:linear-gradient(135deg,#e94560,#0f3460);border-radius:7px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;flex-shrink:0;color:#fff}
.ai-c h4{font-size:14px;font-weight:700;margin-bottom:4px}.ai-c p{font-size:12px;color:var(--tm);line-height:1.5}
.ai-t{display:inline-block;padding:2px 8px;background:rgba(233,69,96,.15);color:var(--h);border-radius:5px;font-size:10px;font-weight:600;text-transform:uppercase;margin-bottom:6px}
.pr{display:flex;align-items:center;gap:14px;margin:10px 0}.pr-l{width:90px;font-size:13px;font-weight:600;flex-shrink:0}
.pr-bg{flex:1;height:24px;background:var(--ib);border-radius:7px;overflow:hidden}
.pr-f{height:100%;border-radius:7px;display:flex;align-items:center;padding-left:10px;font-size:12px;font-weight:700;color:#fff;transition:width 1.5s}
.pr-grn{background:linear-gradient(90deg,#00b894,#00cec9)}.pr-ylw{background:linear-gradient(90deg,#fdcb6e,#f39c12)}.pr-red{background:linear-gradient(90deg,#e94560,#ff6b6b)}
.eg{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin:14px 0}
.ec{background:var(--ib);border:1px solid var(--bd);border-radius:10px;padding:16px;text-align:center}
.ec.rec{border-color:var(--ok);box-shadow:0 0 16px rgba(0,184,148,.15)}
.ec h4{font-size:13px;margin-bottom:10px;text-transform:uppercase;letter-spacing:1px}.ec .eg-v{font-size:20px;font-weight:700;margin-bottom:3px}.ec .eg-t{font-size:12px;color:var(--tm)}
.rl{display:inline-block;background:var(--ok);color:#fff;padding:2px 8px;border-radius:5px;font-size:10px;font-weight:700;text-transform:uppercase;margin-bottom:6px}
.chart-wrap{position:relative;background:var(--ib);border:1px solid var(--bd);border-radius:10px;padding:20px;margin:16px 0}
.chart-canvas{width:100%;height:300px;position:relative}
.chart-svg{width:100%;height:100%}
.chart-tip{display:none;position:absolute;background:var(--s);border:1px solid var(--h);border-radius:8px;padding:10px 14px;font-size:12px;pointer-events:none;z-index:10;min-width:160px}
.chart-tip .ct-day{font-weight:700;color:var(--h);font-size:14px}.chart-tip .ct-val{color:var(--t)}.chart-tip .ct-sub{color:var(--tm);font-size:11px}
.comp-row{background:var(--ib);border:1px solid var(--bd);border-radius:8px;padding:12px 16px;margin:8px 0;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}
.comp-row .cr-title{font-weight:600;font-size:13px}.comp-row .cr-meta{font-size:12px;color:var(--tm)}.comp-row .cr-price{font-size:16px;font-weight:700;color:var(--ok)}
.comp-row .cr-del{background:rgba(233,69,96,.15);color:var(--h);border:0;padding:4px 10px;border-radius:5px;cursor:pointer;font-size:11px}
.vision-result{background:var(--ib);border:1px solid var(--bd);border-radius:10px;padding:20px;margin:16px 0}
.vr-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:12px 0}
.vr-item{text-align:center}.vr-label{font-size:10px;color:var(--tm);text-transform:uppercase}.vr-val{font-size:18px;font-weight:700}
.conf-bar{height:6px;background:var(--ib);border-radius:3px;overflow:hidden;margin:8px 0}.conf-fill{height:100%;border-radius:3px;transition:width 1s}
.import-preview{max-height:300px;overflow:auto;margin:12px 0}
.import-preview table{font-size:12px}
.ts{text-align:center;padding:16px;font-size:11px;color:var(--tm);border-top:1px solid var(--bd);margin-top:30px}
@media(max-width:1024px){.g2{grid-template-columns:1fr}.kpis{grid-template-columns:1fr 1fr}}
@media(max-width:768px){.hd{padding:12px 16px;flex-direction:column;gap:10px}.mx{padding:16px 12px}.fg-grid{grid-template-columns:1fr}.kpis{grid-template-columns:1fr}.eg{grid-template-columns:1fr}.vr-grid{grid-template-columns:1fr 1fr}}
@media print{.hd,.bar,.tabs{display:none!important}body{background:#fff;color:#000}.rc,.kpi,.rpt-hd,.card{border-color:#ddd;background:#fff}}
</style>
</head>
<body>
<div class="hd">
<div class="logo"><div class="logo-i">VI</div><div><h1>Vehicle Inventory Intelligence</h1><span>Dealership Platform v3</span></div></div>
<div class="hd-btns">
<button class="hd-btn" onclick="showPane('add')">+ Add Vehicle</button>
<button class="hd-btn" onclick="showPane('list')">Inventory</button>
<button class="hd-btn" onclick="window.print()">Print</button>
</div>
</div>
<div class="ld" id="ld"><div class="sp"></div><div class="ld-t" id="ldTxt">Processing...</div></div>
<div class="mx">

<!-- TABS -->
<div class="tabs">
<div class="tab on" onclick="showPane('add')">‚ûï Add Vehicle</div>
<div class="tab" onclick="showPane('vision')">üì∑ Photo ID</div>
<div class="tab" onclick="showPane('import')">üìä Spreadsheet</div>
<div class="tab" onclick="showPane('list')">üöó Inventory</div>
<div class="tab" onclick="showPane('analyze')">‚ö° Quick Analyze</div>
</div>

<!-- PANE: VISION ID -->
<div class="pane" id="pane-vision">
<div class="card">
<div class="card-hd"><div class="card-ic" style="background:rgba(116,185,255,.15)">üì∑</div><div><div class="card-tt">AI Vehicle Identification</div><div class="card-st">Paste an image URL or upload a photo</div></div></div>
<div class="fg-grid">
<div class="fg fw"><label>Image URL</label><input type="text" id="visionUrl" placeholder="https://example.com/car-photo.jpg"></div>
<div class="fg fw"><label>Or Upload Image</label><input type="file" id="visionFile" accept="image/*" style="padding:8px"></div>
</div>
<div class="bar" style="margin-top:16px"><button class="btn btn-p btn-sm" onclick="runVision()">üîç Identify Vehicle</button></div>
<div id="visionResult"></div>
</div>
</div>

<!-- PANE: SPREADSHEET IMPORT -->
<div class="pane" id="pane-import">
<div class="card">
<div class="card-hd"><div class="card-ic" style="background:rgba(253,203,110,.15)">üìä</div><div><div class="card-tt">Spreadsheet Import</div><div class="card-st">Upload CSV or XLSX to bulk-add vehicles</div></div></div>
<div class="bar" style="justify-content:flex-start;margin-top:0">
<a href="/api/vehicle/template" class="btn btn-g btn-sm" download>‚¨á Download Template</a>
</div>
<div class="fg-grid" style="margin-top:16px">
<div class="fg fw"><label>Upload File (CSV or XLSX)</label><input type="file" id="importFile" accept=".csv,.xlsx,.xls" style="padding:8px"></div>
</div>
<div class="bar">
<button class="btn btn-s btn-sm" onclick="previewImport()">üëÅ Preview</button>
<button class="btn btn-p btn-sm" onclick="runImport()">üì• Import Vehicles</button>
</div>
<div id="importResult"></div>
</div>
</div>

<!-- PANE: ADD VEHICLE (Manual) -->
<div class="pane on" id="pane-add">
<div class="bar" style="margin-top:0;justify-content:flex-start">
<button class="btn btn-g btn-sm" onclick="loadSample()">‚ñ∂ Load Sample</button>
<button class="btn btn-s btn-sm" onclick="clearForm()">‚úï Clear</button>
</div>
<div class="g2">
<div class="card">
<div class="card-hd"><div class="card-ic" style="background:rgba(233,69,96,.15)">üöó</div><div><div class="card-tt">Vehicle Details</div></div></div>
<div class="fg-grid">
<div class="fg"><label>Year</label><input type="number" id="year" placeholder="2021"></div>
<div class="fg"><label>Make</label><input type="text" id="make" placeholder="Toyota"></div>
<div class="fg"><label>Model</label><input type="text" id="model" placeholder="Camry"></div>
<div class="fg"><label>Trim</label><input type="text" id="trim" placeholder="SE"></div>
<div class="fg"><label>Mileage</label><input type="number" id="mileage" placeholder="41850"></div>
<div class="fg"><label>Ext Color</label><input type="text" id="extColor" placeholder="White"></div>
<div class="fg"><label>Int Color</label><input type="text" id="intColor" placeholder="Black"></div>
<div class="fg"><label>VIN</label><input type="text" id="vin" placeholder="Optional"></div>
<div class="fg fw"><label>Equipment</label><textarea id="equipment" placeholder="Packages, features..."></textarea></div>
</div></div>
<div class="card">
<div class="card-hd"><div class="card-ic" style="background:rgba(0,184,148,.15)">üí∞</div><div><div class="card-tt">Financial Data</div></div></div>
<div class="fg-grid">
<div class="fg"><label>Acquisition Cost</label><input type="number" id="acqCost" placeholder="19400"></div>
<div class="fg"><label>Recon Cost</label><input type="number" id="reconCost" placeholder="850"></div>
<div class="fg"><label>List Price</label><input type="number" id="listPrice" placeholder="23495"></div>
<div class="fg"><label>Floorplan Rate %</label><input type="number" id="fpRate" placeholder="7.25" step="0.25"></div>
<div class="fg"><label>Wholesale Price</label><input type="number" id="wsPrice" placeholder="20300"></div>
<div class="fg"><label>Min Gross</label><input type="number" id="minGross" placeholder="2000"></div>
</div></div>
<div class="card">
<div class="card-hd"><div class="card-ic" style="background:rgba(253,203,110,.15)">üìä</div><div><div class="card-tt">Inventory Status</div></div></div>
<div class="fg-grid">
<div class="fg"><label>Days in Inventory</label><input type="number" id="daysInv" placeholder="52"></div>
<div class="fg"><label>Price Changes</label><input type="number" id="priceChanges" placeholder="1"></div>
<div class="fg fw"><label>Days Since Last Change</label><input type="number" id="daysSinceChange" placeholder="18"></div>
</div></div>
<div class="card">
<div class="card-hd"><div class="card-ic" style="background:rgba(15,52,96,.3)">üåê</div><div><div class="card-tt">Market Context</div></div></div>
<div class="fg-grid">
<div class="fg"><label>Comp Low</label><input type="number" id="compLow" placeholder="22300"></div>
<div class="fg"><label>Comp High</label><input type="number" id="compHigh" placeholder="23900"></div>
<div class="fg"><label>Competing Units</label><input type="number" id="compUnits" placeholder="17"></div>
<div class="fg"><label>Demand</label><select id="demand"><option value="">Select</option><option value="high">High</option><option value="moderate">Moderate</option><option value="soft">Soft</option></select></div>
<div class="fg fw"><label>Seasonal Notes</label><textarea id="seasonal" placeholder="Market timing..."></textarea></div>
</div></div>
</div>
<div class="card">
<div class="card-hd"><div class="card-ic" style="background:rgba(162,155,254,.15)">üì°</div><div><div class="card-tt">Activity Signals</div></div></div>
<div class="fg-grid" style="grid-template-columns:repeat(3,1fr)">
<div class="fg"><label>Views 7d</label><input type="number" id="v7" placeholder="28"></div>
<div class="fg"><label>Views 30d</label><input type="number" id="v30" placeholder="134"></div>
<div class="fg"><label>Leads 7d</label><input type="number" id="l7" placeholder="3"></div>
<div class="fg"><label>Leads 30d</label><input type="number" id="l30" placeholder="11"></div>
<div class="fg"><label>Test Drives 7d</label><input type="number" id="td7" placeholder="1"></div>
<div class="fg"><label>Test Drives 30d</label><input type="number" id="td30" placeholder="4"></div>
<div class="fg fw"><label>Sales Notes</label><textarea id="salesNotes" placeholder="Customer feedback..."></textarea></div>
</div></div>
<div class="bar">
<button class="btn btn-p" onclick="saveAndAnalyze()">‚ö° Save & Analyze</button>
<button class="btn btn-s" onclick="saveVehicle()">üíæ Save Only</button>
</div>
</div>

<!-- PANE: INVENTORY LIST -->
<div class="pane" id="pane-list">
<div class="card"><div class="card-hd"><div class="card-ic" style="background:rgba(0,184,148,.15)">üöó</div><div><div class="card-tt">Vehicle Inventory</div><div class="card-st" id="invCount">0 vehicles</div></div></div>
<div id="vehicleList"><p style="color:var(--tm);text-align:center;padding:40px">No vehicles yet. Add one to get started.</p></div>
</div></div>

<!-- PANE: QUICK ANALYZE -->
<div class="pane" id="pane-analyze">
<div class="card"><div class="card-hd"><div class="card-ic" style="background:rgba(233,69,96,.15)">‚ö°</div><div><div class="card-tt">Quick Analysis</div><div class="card-st">Fill in details and get instant report</div></div></div>
<p style="font-size:13px;color:var(--tm);margin-bottom:12px">Use the "Add Vehicle" tab to enter details, then click "Save & Analyze" for a full report.</p>
</div></div>

<!-- REPORT OUTPUT -->
<div class="rpt" id="rptSection"></div>

<!-- VEHICLE DETAIL VIEW -->
<div class="pane" id="pane-detail"></div>

</div>
<script>
// ============================================================
// STATE
// ============================================================
let vehicles = {};
let currentVehicleId = null;

// ============================================================
// NAVIGATION
// ============================================================
function showPane(name) {
    document.querySelectorAll('.pane').forEach(p => p.classList.remove('on'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
    const pane = document.getElementById('pane-' + name);
    if (pane) pane.classList.add('on');
    document.querySelectorAll('.tab').forEach(t => {
        if (t.textContent.toLowerCase().includes(name) || 
            (name === 'add' && t.textContent.includes('Add')) ||
            (name === 'vision' && t.textContent.includes('Photo')) ||
            (name === 'import' && t.textContent.includes('Spreadsheet')) ||
            (name === 'list' && t.textContent.includes('Inventory')) ||
            (name === 'analyze' && t.textContent.includes('Analyze')))
            t.classList.add('on');
    });
    document.getElementById('rptSection').classList.remove('on');
    if (name === 'list') refreshInventory();
}

function showLoading(msg) {
    document.getElementById('ldTxt').textContent = msg || 'Processing...';
    document.getElementById('ld').classList.add('on');
}
function hideLoading() { document.getElementById('ld').classList.remove('on'); }

function fm(n) { return n < 0 ? '-$' + Math.abs(Math.round(n)).toLocaleString() : '$' + Math.round(n).toLocaleString(); }
function gv(id) { return (document.getElementById(id) || {}).value || ''; }
function gn(id) { return parseFloat(gv(id)) || 0; }

// ============================================================
// SAMPLE DATA
// ============================================================
function loadSample() {
    const s = {year:'2021',make:'Toyota',model:'Camry',trim:'SE',mileage:'41850',extColor:'White',intColor:'Black',
    equipment:'SE Convenience Package, Blind Spot Monitor, Power Driver Seat, Apple CarPlay',
    acqCost:'19400',reconCost:'850',listPrice:'23495',fpRate:'7.25',wsPrice:'20300',minGross:'2000',
    daysInv:'52',priceChanges:'1',daysSinceChange:'18',compLow:'22300',compHigh:'23900',compUnits:'17',
    demand:'moderate',seasonal:'Neutral; steady year-round demand, mild compression from newer model incentives',
    v7:'28',v30:'134',l7:'3',l30:'11',td7:'1',td30:'4',
    salesNotes:'Price resistance versus newer 2023 models; customers asking for $500-$1,000 flexibility'};
    Object.keys(s).forEach(k => { const el = document.getElementById(k); if (el) el.value = s[k]; });
}

function clearForm() {
    document.querySelectorAll('#pane-add input, #pane-add textarea, #pane-add select').forEach(e => {
        e.tagName === 'SELECT' ? e.selectedIndex = 0 : e.value = '';
    });
}

// ============================================================
// COLLECT FORM DATA
// ============================================================
function collectForm() {
    return {
        year: gn('year'), make: gv('make'), model: gv('model'), trim: gv('trim'),
        mileage: gn('mileage'), ext_color: gv('extColor'), int_color: gv('intColor'),
        vin: gv('vin'), equipment: gv('equipment'),
        acquisition_cost: gn('acqCost'), recon_cost: gn('reconCost'), list_price: gn('listPrice'),
        floorplan_rate: gn('fpRate') || 7.25, wholesale_price: gn('wsPrice'), min_gross: gn('minGross') || 2000,
        days_in_inventory: gn('daysInv'), price_changes: gn('priceChanges'), days_since_price_change: gn('daysSinceChange'),
        comp_low: gn('compLow'), comp_high: gn('compHigh'), competing_units: gn('compUnits'),
        demand_signal: gv('demand') || 'moderate', seasonal_notes: gv('seasonal'),
        views_7: gn('v7'), views_30: gn('v30'), leads_7: gn('l7'), leads_30: gn('l30'),
        test_drives_7: gn('td7'), test_drives_30: gn('td30'), sales_notes: gv('salesNotes')
    };
}

// ============================================================
// FEATURE 1: VISION IDENTIFICATION
// ============================================================
async function runVision() {
    const url = gv('visionUrl');
    const fileInput = document.getElementById('visionFile');
    const file = fileInput.files[0];

    if (!url && !file) { alert('Provide an image URL or upload a file'); return; }
    showLoading('Analyzing vehicle image...');

    try {
        let resp;
        if (file) {
            const fd = new FormData();
            fd.append('image', file);
            resp = await fetch('/api/vehicle/identify', { method: 'POST', body: fd });
        } else {
            resp = await fetch('/api/vehicle/identify', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ imageUrl: url })
            });
        }

        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error);
        renderVisionResult(data);
    } catch (e) {
        alert('Vision error: ' + e.message);
    } finally { hideLoading(); }
}

function renderVisionResult(data) {
    const id = data.identification;
    const conf = id.confidence || 0;
    const confPct = Math.round(conf * 100);
    const confColor = conf >= 0.75 ? 'var(--ok)' : conf >= 0.5 ? 'var(--warn)' : 'var(--bad)';
    const confLabel = conf >= 0.75 ? 'HIGH' : conf >= 0.5 ? 'MEDIUM' : 'LOW';

    let html = `<div class="vision-result">
        <h3 style="margin-bottom:12px">Identification Result</h3>
        <div class="vr-grid">
            <div class="vr-item"><div class="vr-label">Year</div><div class="vr-val">${id.year || '‚Äî'}</div></div>
            <div class="vr-item"><div class="vr-label">Make</div><div class="vr-val">${id.make || '‚Äî'}</div></div>
            <div class="vr-item"><div class="vr-label">Model</div><div class="vr-val">${id.model || '‚Äî'}</div></div>
            <div class="vr-item"><div class="vr-label">Trim</div><div class="vr-val">${id.trim || '‚Äî'}</div></div>
        </div>
        <div style="margin:12px 0">
            <div style="display:flex;align-items:center;gap:10px">
                <span style="font-size:12px;color:var(--tm)">Confidence:</span>
                <span class="badge" style="background:${confColor}20;color:${confColor}">${confLabel} ‚Äî ${confPct}%</span>
            </div>
            <div class="conf-bar"><div class="conf-fill" style="width:${confPct}%;background:${confColor}"></div></div>
        </div>
        <p style="font-size:12px;color:var(--tm)">${id.notes || ''}</p>
        <p style="font-size:12px;color:var(--tm);margin-top:4px">Provider: ${data.provider}</p>`;

    if (data.below_threshold) {
        html += `<div class="co co-y" style="margin-top:12px"><h4>Low Confidence</h4>
            <p>Identification confidence is below threshold. Use spreadsheet import or manual entry for accuracy.</p></div>`;
    }

    if (id.year || id.make || id.model) {
        html += `<div class="bar" style="justify-content:flex-start;margin-top:12px">
            <button class="btn btn-g btn-sm" onclick="applyVisionToForm()">‚úì Use This & Go to Form</button></div>`;
    }

    html += `</div>`;

    // Store for apply
    window._lastVision = id;
    document.getElementById('visionResult').innerHTML = html;
}

function applyVisionToForm() {
    const id = window._lastVision;
    if (!id) return;
    if (id.year) document.getElementById('year').value = id.year;
    if (id.make) document.getElementById('make').value = id.make;
    if (id.model) document.getElementById('model').value = id.model;
    if (id.trim) document.getElementById('trim').value = id.trim;
    showPane('add');
}

// ============================================================
// FEATURE 1B: SPREADSHEET IMPORT
// ============================================================
async function previewImport() {
    const file = document.getElementById('importFile').files[0];
    if (!file) { alert('Select a file first'); return; }
    showLoading('Parsing spreadsheet...');
    try {
        const fd = new FormData();
        fd.append('file', file);
        fd.append('preview_only', 'true');
        const resp = await fetch('/api/vehicle/import', { method: 'POST', body: fd });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error);
        renderImportPreview(data);
    } catch (e) { alert('Import error: ' + e.message); }
    finally { hideLoading(); }
}

async function runImport() {
    const file = document.getElementById('importFile').files[0];
    if (!file) { alert('Select a file first'); return; }
    showLoading('Importing vehicles...');
    try {
        const fd = new FormData();
        fd.append('file', file);
        const resp = await fetch('/api/vehicle/import', { method: 'POST', body: fd });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error);

        let html = `<div class="co co-g"><h4>Import Complete</h4><p>${data.imported.length} vehicles imported.</p></div>`;
        if (data.import_errors && data.import_errors.length) {
            html += `<div class="co co-y"><h4>${data.import_errors.length} Errors</h4><ul>`;
            data.import_errors.forEach(e => html += `<li>Row ${e.row}: ${e.error}</li>`);
            html += `</ul></div>`;
        }
        document.getElementById('importResult').innerHTML = html;
    } catch (e) { alert('Import error: ' + e.message); }
    finally { hideLoading(); }
}

function renderImportPreview(data) {
    if (!data.rows || !data.rows.length) {
        document.getElementById('importResult').innerHTML = '<div class="co co-y"><h4>No Data</h4><p>No rows found in file.</p></div>';
        return;
    }
    const cols = Object.keys(data.rows[0]);
    let html = `<div class="co co-b"><h4>Preview ‚Äî ${data.row_count} rows found</h4><p>Review below, then click Import.</p></div>`;
    html += `<div class="import-preview"><table class="tbl"><thead><tr>`;
    cols.forEach(c => html += `<th>${c}</th>`);
    html += `</tr></thead><tbody>`;
    data.rows.slice(0, 20).forEach(row => {
        html += '<tr>';
        cols.forEach(c => html += `<td>${row[c] || ''}</td>`);
        html += '</tr>';
    });
    html += `</tbody></table></div>`;
    if (data.row_count > 20) html += `<p style="font-size:12px;color:var(--tm)">Showing 20 of ${data.row_count}</p>`;
    document.getElementById('importResult').innerHTML = html;
}

// ============================================================
// SAVE VEHICLE
// ============================================================
async function saveVehicle() {
    const data = collectForm();
    if (!data.year || !data.make || !data.model || !data.acquisition_cost || !data.list_price) {
        alert('Fill in Year, Make, Model, Acquisition Cost, List Price'); return;
    }
    showLoading('Saving vehicle...');
    try {
        const resp = await fetch('/api/vehicles', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
        });
        const result = await resp.json();
        if (!resp.ok) throw new Error(result.error);
        vehicles[result.vehicle.id] = result.vehicle;
        alert('Vehicle saved!');
        showPane('list');
    } catch (e) { alert('Save error: ' + e.message); }
    finally { hideLoading(); }
}

async function saveAndAnalyze() {
    const data = collectForm();
    if (!data.year || !data.make || !data.model || !data.acquisition_cost || !data.list_price) {
        alert('Fill in Year, Make, Model, Acquisition Cost, List Price'); return;
    }
    showLoading('Analyzing vehicle...');
    try {
        const resp = await fetch('/api/analyze', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
        });
        const result = await resp.json();
        if (!resp.ok) throw new Error(result.error);
        renderFullReport(data, result.report.analysis);
    } catch (e) { alert('Analysis error: ' + e.message); }
    finally { hideLoading(); }
}

// ============================================================
// INVENTORY LIST
// ============================================================
async function refreshInventory() {
    try {
        const resp = await fetch('/api/vehicles');
        const data = await resp.json();
        vehicles = {};
        data.vehicles.forEach(v => vehicles[v.id] = v);
        document.getElementById('invCount').textContent = data.count + ' vehicles';
        renderInventoryList(data.vehicles);
    } catch (e) { console.error('Refresh error:', e); }
}

function renderInventoryList(list) {
    if (!list.length) {
        document.getElementById('vehicleList').innerHTML = '<p style="color:var(--tm);text-align:center;padding:40px">No vehicles yet.</p>';
        return;
    }
    let html = '';
    list.forEach(v => {
        const zone = v.days_in_inventory <= 30 ? 'b-grn' : (v.days_in_inventory <= 60 ? 'b-ylw' : 'b-red');
        const zoneText = v.days_in_inventory <= 30 ? 'HEALTHY' : (v.days_in_inventory <= 60 ? 'AT-RISK' : 'DANGER');
        html += `<div class="comp-row">
            <div><div class="cr-title">${v.year} ${v.make} ${v.model} ${v.trim||''}</div>
            <div class="cr-meta">${v.mileage?v.mileage.toLocaleString()+' mi':'No mileage'} ¬∑ ${v.ext_color||''}/${v.int_color||''} ¬∑ ${v.days_in_inventory}d <span class="badge ${zone}">${zoneText}</span></div></div>
            <div style="display:flex;gap:8px;align-items:center">
                <div class="cr-price">${fm(v.list_price)}</div>
                <button class="btn btn-g btn-sm" onclick="viewVehicle('${v.id}')">View</button>
                <button class="btn btn-p btn-sm" onclick="analyzeVehicle('${v.id}')">Analyze</button>
                <button class="cr-del" onclick="deleteVehicle('${v.id}')">‚úï</button>
            </div></div>`;
    });
    document.getElementById('vehicleList').innerHTML = html;
}

async function deleteVehicle(id) {
    if (!confirm('Delete this vehicle?')) return;
    await fetch('/api/vehicles/' + id, { method: 'DELETE' });
    refreshInventory();
}

async function analyzeVehicle(id) {
    showLoading('Running analysis...');
    try {
        const resp = await fetch('/api/vehicles/' + id + '/analyze', { method: 'POST' });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error);
        const v = vehicles[id];
        renderFullReport(v, data.report.analysis);
    } catch (e) { alert('Error: ' + e.message); }
    finally { hideLoading(); }
}

// ============================================================
// VEHICLE DETAIL VIEW WITH COMPS + ODDS
// ============================================================
async function viewVehicle(id) {
    currentVehicleId = id;
    showLoading('Loading vehicle...');
    try {
        const [vResp, cResp, oResp] = await Promise.all([
            fetch('/api/vehicles/' + id),
            fetch('/api/vehicle/' + id + '/comps'),
            fetch('/api/vehicle/' + id + '/odds?maxDays=90')
        ]);
        const vData = await vResp.json();
        const cData = await cResp.json();
        const oData = await oResp.json();

        renderDetailView(vData.vehicle, cData.comps || [], oData);
    } catch (e) { alert('Error: ' + e.message); }
    finally { hideLoading(); }
}

function renderDetailView(v, comps, odds) {
    document.querySelectorAll('.pane').forEach(p => p.classList.remove('on'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
    document.getElementById('rptSection').classList.remove('on');

    const pane = document.getElementById('pane-detail');
    pane.classList.add('on');

    const title = `${v.year} ${v.make} ${v.model} ${v.trim || ''}`.trim();
    const zone = v.days_in_inventory <= 30 ? 'HEALTHY' : (v.days_in_inventory <= 60 ? 'AT-RISK' : 'DANGER');
    const zBadge = zone === 'HEALTHY' ? 'b-grn' : (zone === 'AT-RISK' ? 'b-ylw' : 'b-red');

    let html = `
    <div style="display:flex;gap:10px;margin-bottom:16px">
        <button class="btn btn-s btn-sm" onclick="showPane('list')">‚Üê Back</button>
        <button class="btn btn-p btn-sm" onclick="analyzeVehicle('${v.id}')">‚ö° Full Analysis</button>
        <button class="btn btn-g btn-sm" onclick="findComps('${v.id}')">üîç Find Comps</button>
    </div>
    <div class="rpt-hd">
        <h2>${title}</h2>
        <div class="meta">
            <div class="meta-i"><span class="meta-l">Mileage</span><span class="meta-v">${v.mileage ? v.mileage.toLocaleString() + ' mi' : '‚Äî'}</span></div>
            <div class="meta-i"><span class="meta-l">Color</span><span class="meta-v">${v.ext_color || '‚Äî'}/${v.int_color || '‚Äî'}</span></div>
            <div class="meta-i"><span class="meta-l">Days</span><span class="meta-v">${v.days_in_inventory}</span></div>
            <div class="meta-i"><span class="meta-l">Zone</span><span class="badge ${zBadge}">${zone}</span></div>
            <div class="meta-i"><span class="meta-l">List</span><span class="meta-v">${fm(v.list_price)}</span></div>
        </div>
    </div>`;

    // ODDS SECTION
    if (odds && odds.summary) {
        const s = odds.summary;
        html += `<div class="rc"><div class="rc-h"><div class="rc-n">üìà</div><div class="rc-t">Sell Probability ‚Äî 30/60/90 Day</div></div><div class="rc-b">
        <div class="kpis" style="grid-template-columns:repeat(3,1fr);margin-bottom:16px">
            <div class="kpi"><div class="kpi-l">30-Day</div><div class="kpi-v ${s.p_30_day>50?'grn':s.p_30_day>30?'ylw':'red'}">${s.p_30_day}%</div></div>
            <div class="kpi"><div class="kpi-l">60-Day</div><div class="kpi-v ${s.p_60_day>60?'grn':s.p_60_day>40?'ylw':'red'}">${s.p_60_day}%</div></div>
            <div class="kpi"><div class="kpi-l">90-Day</div><div class="kpi-v ${s.p_90_day>70?'grn':s.p_90_day>50?'ylw':'red'}">${s.p_90_day}%</div></div>
        </div>
        <p>Peak sell probability: <strong>Day ${s.peak_day}</strong> (${s.peak_daily_pct}%/day). Median sell day: <strong>${s.median_sell_day}</strong>.</p>
        <div class="chart-wrap">
            <canvas id="oddsChart" width="800" height="300" style="width:100%;height:300px;cursor:crosshair"></canvas>
            <div class="chart-tip" id="chartTip"></div>
        </div>
        </div></div>`;
    }

    // COMPS SECTION
    html += `<div class="rc"><div class="rc-h"><div class="rc-n">üìä</div><div class="rc-t">Comparable Sales (${comps.length})</div></div><div class="rc-b">
    <div class="bar" style="justify-content:flex-start;margin-top:0">
        <button class="btn btn-g btn-sm" onclick="findComps('${v.id}')">üîç Auto-Find Comps</button>
        <button class="btn btn-s btn-sm" onclick="showAddComp('${v.id}')">+ Manual Comp</button>
    </div>
    <div id="compFormArea"></div>
    <div id="compsList">`;

    if (comps.length) {
        comps.forEach(c => {
            html += `<div class="comp-row">
                <div><div class="cr-title">${c.year||''} ${c.make||''} ${c.model||''} ${c.trim||''}</div>
                <div class="cr-meta">${c.source} ¬∑ ${c.mileage?c.mileage.toLocaleString()+' mi':''} ¬∑ ${c.location||''} ¬∑ ${c.days_on_market?c.days_on_market+'d DOM':''}</div></div>
                <div style="display:flex;gap:8px;align-items:center">
                    <div class="cr-price">${c.sold_price ? fm(c.sold_price) : '‚Äî'}</div>
                    <button class="cr-del" onclick="deleteComp('${v.id}','${c.id}')">‚úï</button>
                </div></div>`;
        });
    } else {
        html += '<p style="color:var(--tm);text-align:center;padding:20px">No comps yet. Click "Auto-Find" or add manually.</p>';
    }

    html += `</div></div></div>`;
    pane.innerHTML = html;

    // Draw chart after DOM update
    if (odds && odds.curve) {
        setTimeout(() => drawOddsChart(odds.curve), 100);
    }
}

// ============================================================
// FEATURE 2: COMPS
// ============================================================
async function findComps(vehicleId) {
    showLoading('Searching for comps...');
    try {
        const resp = await fetch('/api/vehicle/' + vehicleId + '/comps/find', { method: 'POST' });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error);
        viewVehicle(vehicleId); // Refresh view
    } catch (e) { alert('Comp search error: ' + e.message); }
    finally { hideLoading(); }
}

function showAddComp(vehicleId) {
    const area = document.getElementById('compFormArea');
    area.innerHTML = `<div class="card" style="margin:12px 0">
        <div class="fg-grid">
            <div class="fg"><label>Sold Price</label><input type="number" id="mc_price" placeholder="22500"></div>
            <div class="fg"><label>Mileage</label><input type="number" id="mc_miles" placeholder="38000"></div>
            <div class="fg"><label>Source</label><input type="text" id="mc_source" placeholder="Auction, Dealer, etc."></div>
            <div class="fg"><label>Location</label><input type="text" id="mc_loc" placeholder="Dallas, TX"></div>
            <div class="fg"><label>Days on Market</label><input type="number" id="mc_dom" placeholder="28"></div>
            <div class="fg"><label>Sold Date</label><input type="date" id="mc_date"></div>
            <div class="fg fw"><label>Notes</label><input type="text" id="mc_notes" placeholder="Optional notes"></div>
        </div>
        <div class="bar" style="justify-content:flex-start">
            <button class="btn btn-p btn-sm" onclick="submitComp('${vehicleId}')">Add Comp</button>
            <button class="btn btn-s btn-sm" onclick="document.getElementById('compFormArea').innerHTML=''">Cancel</button>
        </div></div>`;
}

async function submitComp(vehicleId) {
    const v = vehicles[vehicleId];
    const comp = {
        sold_price: parseFloat(document.getElementById('mc_price').value) || 0,
        mileage: parseInt(document.getElementById('mc_miles').value) || 0,
        source: document.getElementById('mc_source').value || 'Manual',
        location: document.getElementById('mc_loc').value || '',
        days_on_market: parseInt(document.getElementById('mc_dom').value) || 0,
        sold_date: document.getElementById('mc_date').value || '',
        notes: document.getElementById('mc_notes').value || '',
        year: v ? v.year : '', make: v ? v.make : '', model: v ? v.model : '', trim: v ? v.trim : ''
    };
    try {
        const resp = await fetch('/api/vehicle/' + vehicleId + '/comps', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(comp)
        });
        if (!resp.ok) throw new Error((await resp.json()).error);
        viewVehicle(vehicleId);
    } catch (e) { alert('Error: ' + e.message); }
}

async function deleteComp(vehicleId, compId) {
    await fetch('/api/vehicle/' + vehicleId + '/comps/' + compId, { method: 'DELETE' });
    viewVehicle(vehicleId);
}

// ============================================================
// FEATURE 3: INTERACTIVE ODDS CHART (Canvas)
// ============================================================
function drawOddsChart(curve) {
    const canvas = document.getElementById('oddsChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();

    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);

    const W = rect.width;
    const H = rect.height;
    const pad = { t: 20, r: 20, b: 40, l: 50 };
    const cW = W - pad.l - pad.r;
    const cH = H - pad.t - pad.b;

    const maxCum = Math.max(...curve.map(p => p.cumulative_pct), 10);
    const maxDaily = Math.max(...curve.map(p => p.daily_pct), 1);

    // Background
    ctx.fillStyle = '#0d1b2a';
    ctx.fillRect(0, 0, W, H);

    // Grid lines
    ctx.strokeStyle = '#1e2a3a';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 5; i++) {
        const y = pad.t + (cH / 5) * i;
        ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(W - pad.r, y); ctx.stroke();
    }
    // Vertical grid at 30, 60, 90
    [30, 60, 90].forEach(d => {
        if (d <= curve.length) {
            const x = pad.l + (d / curve.length) * cW;
            ctx.strokeStyle = '#2d3e50';
            ctx.beginPath(); ctx.moveTo(x, pad.t); ctx.lineTo(x, H - pad.b); ctx.stroke();
            ctx.fillStyle = '#636e72';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Day ' + d, x, H - pad.b + 16);
        }
    });

    // Y axis labels
    ctx.fillStyle = '#636e72';
    ctx.font = '11px sans-serif';
    ctx.textAlign = 'right';
    for (let i = 0; i <= 5; i++) {
        const val = Math.round(maxCum / 5 * (5 - i));
        const y = pad.t + (cH / 5) * i;
        ctx.fillText(val + '%', pad.l - 8, y + 4);
    }

    // Draw cumulative line
    ctx.beginPath();
    ctx.strokeStyle = '#e94560';
    ctx.lineWidth = 2.5;
    curve.forEach((p, i) => {
        const x = pad.l + (i / (curve.length - 1)) * cW;
        const y = pad.t + cH - (p.cumulative_pct / maxCum) * cH;
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    ctx.stroke();

    // Draw cumulative fill
    ctx.lineTo(pad.l + cW, pad.t + cH);
    ctx.lineTo(pad.l, pad.t + cH);
    ctx.closePath();
    const grad = ctx.createLinearGradient(0, pad.t, 0, H - pad.b);
    grad.addColorStop(0, 'rgba(233, 69, 96, 0.2)');
    grad.addColorStop(1, 'rgba(233, 69, 96, 0.02)');
    ctx.fillStyle = grad;
    ctx.fill();

    // Draw daily bars
    const barW = Math.max(1, (cW / curve.length) * 0.6);
    curve.forEach((p, i) => {
        const x = pad.l + (i / (curve.length - 1)) * cW - barW / 2;
        const barH = (p.daily_pct / maxDaily) * (cH * 0.3);
        const y = pad.t + cH - barH;
        ctx.fillStyle = 'rgba(0, 184, 148, 0.4)';
        ctx.fillRect(x, y, barW, barH);
    });

    // Labels
    ctx.fillStyle = '#e94560';
    ctx.font = 'bold 11px sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText('‚Äî Cumulative %', pad.l + 10, pad.t + 14);
    ctx.fillStyle = 'rgba(0,184,148,0.8)';
    ctx.fillText('‚ñà Daily %', pad.l + 130, pad.t + 14);

    // Hover interaction
    const tip = document.getElementById('chartTip');
    canvas.onmousemove = function(e) {
        const cRect = canvas.getBoundingClientRect();
        const mx = e.clientX - cRect.left;
        const my = e.clientY - cRect.top;

        if (mx < pad.l || mx > W - pad.r || my < pad.t || my > H - pad.b) {
            tip.style.display = 'none';
            return;
        }

        const dayIdx = Math.round(((mx - pad.l) / cW) * (curve.length - 1));
        const dayData = curve[Math.max(0, Math.min(dayIdx, curve.length - 1))];

        tip.style.display = 'block';
        tip.style.left = (mx + 15) + 'px';
        tip.style.top = (my - 10) + 'px';

        if (mx > W * 0.7) tip.style.left = (mx - 175) + 'px';

        tip.innerHTML = `
            <div class="ct-day">Day ${dayData.day}</div>
            <div class="ct-val">Daily: ${dayData.daily_pct}%</div>
            <div class="ct-val">Cumulative: ${dayData.cumulative_pct}%</div>
            <div class="ct-sub">Gross if sold: ${fm(dayData.gross_if_sold)}</div>
            <div class="ct-sub">Floorplan: ${fm(dayData.floorplan_cost)}</div>`;
    };

    canvas.onmouseleave = function() { tip.style.display = 'none'; };
}
  // ============================================================
// FULL REPORT RENDERER
// ============================================================
function renderFullReport(d, a) {
    document.querySelectorAll('.pane').forEach(p => p.classList.remove('on'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('on'));

    const sec = document.getElementById('rptSection');
    sec.classList.add('on');

    const title = `${d.year||a.summary?.vehicle||''} ${d.make||''} ${d.model||''} ${d.trim||''}`.trim() || a.summary?.vehicle || 'Vehicle';
    const f = a.financials || {};
    const p = a.pricing || {};
    const sp = a.sale_probability || {};
    const ag = a.aging || {};
    const ep = a.exit_path || {};
    const rc = a.risk_and_confidence || {};
    const zone = ag.zone || 'UNKNOWN';
    const zB = zone === 'HEALTHY' ? 'b-grn' : zone === 'AT-RISK' ? 'b-ylw' : 'b-red';
    const gC = (f.current_net_gross || 0) > 2000 ? 'grn' : (f.current_net_gross || 0) > 0 ? 'ylw' : 'red';

    let h = `
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-bottom:16px">
        <button class="btn btn-s btn-sm" onclick="showPane('add')">‚Üê Back</button>
        <button class="btn btn-s btn-sm" onclick="window.print()">üñ® Print</button>
    </div>
    <div class="rpt-hd"><h2>${title}</h2>
        <div class="meta">
            <div class="meta-i"><span class="meta-l">Mileage</span><span class="meta-v">${(d.mileage||0).toLocaleString()} mi</span></div>
            <div class="meta-i"><span class="meta-l">Color</span><span class="meta-v">${d.ext_color||'‚Äî'}/${d.int_color||'‚Äî'}</span></div>
            <div class="meta-i"><span class="meta-l">Days</span><span class="meta-v">${d.days_in_inventory||ag.days_in_inventory||0}</span></div>
            <div class="meta-i"><span class="meta-l">Zone</span><span class="badge ${zB}">${zone}</span></div>
        </div>
    </div>
    <div class="kpis">
        <div class="kpi"><div class="kpi-l">Total Invested</div><div class="kpi-v blu">${fm(f.total_invested||0)}</div></div>
        <div class="kpi"><div class="kpi-l">Net Gross</div><div class="kpi-v ${gC}">${fm(f.current_net_gross||0)}</div><div class="kpi-d">After ${fm(f.floorplan_accrued_to_date||0)} FP</div></div>
        <div class="kpi"><div class="kpi-l">Daily FP</div><div class="kpi-v red">$${(f.daily_floorplan_cost||0).toFixed(2)}</div></div>
        <div class="kpi"><div class="kpi-l">WS Exit</div><div class="kpi-v ${(f.wholesale_net_today||0)>=0?'ylw':'red'}">${fm(f.wholesale_net_today||0)}</div></div>
    </div>`;

    // 1. Sale Probability
    if (sp.prob_30_day !== undefined) {
        h += `<div class="rc"><div class="rc-h"><div class="rc-n">1</div><div class="rc-t">Sale Probability</div></div><div class="rc-b">
        <div class="pr"><div class="pr-l">30 Days</div><div class="pr-bg"><div class="pr-f ${sp.prob_30_day>50?'pr-grn':sp.prob_30_day>30?'pr-ylw':'pr-red'}" style="width:${sp.prob_30_day}%">${sp.prob_30_day}%</div></div></div>
        <div class="pr"><div class="pr-l">60 Days</div><div class="pr-bg"><div class="pr-f ${sp.prob_60_day>60?'pr-grn':sp.prob_60_day>40?'pr-ylw':'pr-red'}" style="width:${sp.prob_60_day}%">${sp.prob_60_day}%</div></div></div>
        <div class="pr"><div class="pr-l">90 Days</div><div class="pr-bg"><div class="pr-f ${sp.prob_90_day>70?'pr-grn':sp.prob_90_day>50?'pr-ylw':'pr-red'}" style="width:${sp.prob_90_day}%">${sp.prob_90_day}%</div></div></div>`;

        if (sp.daily_curve && sp.daily_curve.length) {
            h += `<div class="chart-wrap"><canvas id="reportChart" width="800" height="300" style="width:100%;height:300px;cursor:crosshair"></canvas><div class="chart-tip" id="rptChartTip"></div></div>`;
        }
        h += `</div></div>`;
    }

    // 2. Aging
    if (ag.erosion_table) {
        h += `<div class="rc"><div class="rc-h"><div class="rc-n">2</div><div class="rc-t">Aging & Erosion</div></div><div class="rc-b">
        <p>Zone: <span class="badge ${zB}">${zone}</span></p>
        <table class="tbl"><thead><tr><th>+Days</th><th>Total</th><th>FP Accrued</th><th>Gross (Sticker)</th><th>Realistic Gross</th></tr></thead><tbody>`;
        ag.erosion_table.forEach((r, i) => {
            h += `<tr><td>${i===0?'<strong>Today</strong>':'+'+r.additional_days}</td><td>${r.total_days}</td><td>${fm(r.floorplan_accrued)}</td><td>${fm(r.gross_at_sticker)}</td><td>${fm(r.realistic_gross_low)} ‚Äì ${fm(r.realistic_gross_high)}</td></tr>`;
        });
        h += `</tbody></table>`;
        if (ag.irrationality_threshold) {
            h += `<div class="co co-r"><h4>Irrationality: Day ${ag.irrationality_threshold.day}</h4><p>${ag.irrationality_threshold.days_remaining||0} days remaining before wholesale becomes the rational exit.</p></div>`;
        }
        h += `</div></div>`;
    }

    // 3. Pricing
    if (p.action) {
        const pColor = p.action==='REDUCE'?'var(--h)':p.action==='INCREASE'?'var(--ok)':'#74b9ff';
        h += `<div class="rc"><div class="rc-h"><div class="rc-n">3</div><div class="rc-t">Pricing Strategy</div></div><div class="rc-b">
        <div class="rb"><div class="rb-a" style="color:${pColor}">${p.action==='REDUCE'?'‚Üì REDUCE '+fm(p.change_amount):p.action==='INCREASE'?'‚Üë INCREASE '+fm(p.change_amount):'‚óè HOLD'}</div>
        <div class="rb-d">${p.action!=='HOLD'?'New: <strong>'+fm(p.new_list_price)+'</strong>':'Maintain <strong>'+fm(p.current_list_price)+'</strong>'}</div>
        <div class="rb-s">${p.timing||''}</div></div>
        <p>${p.reasoning||''}</p>
        <div class="co co-b"><h4>Elasticity: ${typeof p.elasticity==='object'?p.elasticity.level:p.elasticity||'‚Äî'}</h4>
        <p>${typeof p.elasticity==='object'?p.elasticity.detail:''}</p></div>
        <p>Expected transaction: <strong>${fm((p.expected_transaction_range||{}).low||0)} ‚Äì ${fm((p.expected_transaction_range||{}).high||0)}</strong></p>
        <p>Expected gross: <strong>${fm((p.expected_gross_range||{}).low||0)} ‚Äì ${fm((p.expected_gross_range||{}).high||0)}</strong></p>
        </div></div>`;
    }

    // 4. Exit Path
    if (ep.paths) {
        h += `<div class="rc"><div class="rc-h"><div class="rc-n">4</div><div class="rc-t">Optimal Exit Path</div></div><div class="rc-b">
        <div class="eg">`;
        ep.paths.forEach(path => {
            h += `<div class="ec ${path.recommended?'rec':''}">
                ${path.recommended?'<div class="rl">RECOMMENDED</div>':''}
                <h4>${path.path.replace('_',' ')}</h4>
                <div class="eg-v ${path.recommended?'grn':''}">${fm(path.expected_gross_low)}${path.expected_gross_high!==path.expected_gross_low?' ‚Äì '+fm(path.expected_gross_high):''}</div>
                <div class="eg-t">${path.expected_days} ¬∑ ${path.probability}</div>
            </div>`;
        });
        h += `</div><p>${ep.reasoning||''}</p></div></div>`;
    }

    // 5. Action Plan
    if (a.action_plan && a.action_plan.length) {
        h += `<div class="rc"><div class="rc-h"><div class="rc-n">5</div><div class="rc-t">Action Plan</div></div><div class="rc-b">`;
        a.action_plan.forEach(act => {
            h += `<div class="ai"><div class="ai-n">${act.priority}</div><div class="ai-c">
                <div class="ai-t">${act.timing}</div><h4>${act.title}</h4><p>${act.detail}</p>
                <p style="margin-top:4px;font-style:italic"><strong>Purpose:</strong> ${act.purpose}</p>
            </div></div>`;
        });
        h += `</div></div>`;
    }

    // 6. Risk
    if (rc.risks) {
        h += `<div class="rc"><div class="rc-h"><div class="rc-n">6</div><div class="rc-t">Risk & Confidence</div></div><div class="rc-b">`;
        rc.risks.forEach(r => {
            const sev = r.severity || 'LOW';
            const sc = sev === 'HIGH' ? 'co-r' : sev === 'MEDIUM' ? 'co-y' : 'co-b';
            const sb = sev === 'HIGH' ? 'b-red' : sev === 'MEDIUM' ? 'b-ylw' : 'b-grn';
            h += `<div class="co ${sc}"><h4>${r.factor} <span class="badge ${sb}">${sev}</span></h4><p>${r.detail||''}</p></div>`;
        });
        if (rc.confidence) {
            const cl = rc.confidence.level || 'MEDIUM';
            const cp = rc.confidence.percent || 50;
            const cc = cl === 'HIGH' ? 'var(--ok)' : cl === 'MEDIUM' ? 'var(--warn)' : 'var(--bad)';
            h += `<h3>Confidence: ${cl}</h3>
            <div style="display:flex;align-items:center;gap:10px;margin:12px 0">
                <div class="conf-bar" style="flex:1"><div class="conf-fill" style="width:${cp}%;background:${cc}"></div></div>
                <span style="font-weight:700">${cp}%</span>
            </div>`;
        }
        h += `</div></div>`;
    }

    h += `<div class="ts">Analysis generated ${new Date().toLocaleString()} ‚Äî Vehicle Inventory Intelligence v3.0</div>`;

    sec.innerHTML = h;
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // Draw chart if curve data exists
    if (sp.daily_curve && sp.daily_curve.length) {
        setTimeout(() => {
            drawReportChart(sp.daily
